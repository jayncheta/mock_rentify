import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../browse.dart'
    show primaryColor; // Import primary color
import '../services/items_service.dart' show ItemsService;

// --- Added imports ---
import 'package:image_picker/image_picker.dart'; // 1. For picking images
import 'dart:io'; // 2. For displaying the File
import 'package:flutter/foundation.dart'
    show kIsWeb; // 3. For checking if it's Web or Mobile
import 'edit.dart' show EditItemsScreen;
import 'disable.dart' show DisableItemsScreen;
// ---

// Additional colors from the image
const Color formFieldBackgroundColor = Color(0xFFFBE7D7);
const Color addButtonColor = Color(0xFF4CAF50);
final Color tabInactiveColor = Colors.grey[700]!;

class AddItemsScreen extends StatefulWidget {
  // Changed to StatefulWidget to hold the state of the selected image
  const AddItemsScreen({super.key});

  static const String routeName = '/staff/add';

  @override
  State<AddItemsScreen> createState() => _AddItemsScreenState();
}

class _AddItemsScreenState extends State<AddItemsScreen> {
  // Controllers for form fields
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();

  // State for holding the selected category
  String? _selectedCategory;
  final List<String> _categories = [
    "Electronics",
    "Furniture",
    "Tools",
    "Other",
  ];

  // --- State added for the image ---
  XFile? _imageFile; // Variable to store the picked image file
  final ImagePicker _picker = ImagePicker(); // The image picker instance

  // --- Function to pick an image ---
  Future<void> _pickImage(ImageSource source) async {
    try {
      final XFile? pickedFile = await _picker.pickImage(
        source: source,
        maxWidth: 800, // You can set the image size
        imageQuality: 85, // You can set the image quality
      );

      if (pickedFile != null) {
        setState(() {
          _imageFile = pickedFile;
        });
      }
    } catch (e) {
      // Handle errors (e.g., user denied permission)
      debugPrint("Failed to pick image: $e");
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Failed to pick image. Error: $e")),
        );
      }
    }
  }

  // --- Function to show picker options (Gallery or Camera) ---
  void _showImagePickerOptions() {
    showModalBottomSheet(
      context: context,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) {
        return SafeArea(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: const Icon(Icons.photo_library),
                title: const Text('Select from Gallery'), // Translated
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.gallery);
                },
              ),
              ListTile(
                leading: const Icon(Icons.camera_alt),
                title: const Text('Take with Camera'), // Translated
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.camera);
                },
              ),
            ],
          ),
        );
      },
    );
  }
  // --- End of image code section ---

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        leading: Padding(
          padding: const EdgeInsets.all(8.0),
          child: CircleAvatar(
            backgroundColor: Colors.grey[200],
            child: IconButton(icon: const Icon(Icons.person), onPressed: () {}),
          ),
        ),
        title: Text(
          'Add Assets',
          style: GoogleFonts.poppins(fontWeight: FontWeight.w700),
        ),
        actions: [
          TextButton(
            style: TextButton.styleFrom(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              minimumSize: const Size(56, 36),
            ),
            onPressed: () {
              Navigator.pushNamed(context, EditItemsScreen.routeName);
            },
            child: Text(
              'Edit',
              style: GoogleFonts.poppins(color: Colors.black),
            ),
          ),
          TextButton(
            onPressed: () {
              ScaffoldMessenger.of(
                context,
              ).showSnackBar(const SnackBar(content: Text('History tapped')));
            },
            child: Text(
              'History',
              style: GoogleFonts.poppins(color: Colors.black),
            ),
          ),
          TextButton(
            onPressed: () {
              ScaffoldMessenger.of(
                context,
              ).showSnackBar(const SnackBar(content: Text('Request tapped')));
            },
            child: Text(
              'Request',
              style: GoogleFonts.poppins(color: Colors.black),
            ),
          ),
          TextButton(
            onPressed: () {
              showDialog<void>(
                context: context,
                builder: (context) => AlertDialog(
                  title: Text(
                    'Logout',
                    style: GoogleFonts.poppins(fontWeight: FontWeight.w600),
                  ),
                  content: Text(
                    'Are you sure you want to logout?',
                    style: GoogleFonts.poppins(),
                  ),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.of(context).pop(),
                      child: Text('Cancel', style: GoogleFonts.poppins()),
                    ),
                    TextButton(
                      onPressed: () {
                        Navigator.of(context).pop();
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(content: Text('Logged out')),
                        );
                        Navigator.pushNamedAndRemoveUntil(
                          context,
                          '/',
                          (route) => false,
                        );
                      },
                      child: Text(
                        'Logout',
                        style: GoogleFonts.poppins(color: Colors.red),
                      ),
                    ),
                  ],
                ),
              );
            },
            child: Text(
              'Logout',
              style: GoogleFonts.poppins(color: Colors.red),
            ),
          ),
        ],
        backgroundColor: Colors.white,
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.black),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            const SizedBox(height: 16),

            // 2. Tabs (Add, Edit, Disable)
            buildTabs(context),
            const SizedBox(height: 24),

            // 3. Form fields
            buildForm(),
            const SizedBox(height: 32),

            // 4. Buttons (Cancel, Add)
            buildActionButtons(),
          ],
        ),
      ),
    );
  }

  // (orange header removed — AppBar added at scaffold level)

  // Widget for the "Add", "Edit", "Disable" Tabs
  Widget buildTabs(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceAround,
      children: [
        buildTabItem(
          title: "Add", // <-- 'title:' parameter fix
          isSelected: true,
          onTap: () {
            // Already on this page
          },
        ),
        buildTabItem(
          title: "Edit", // <-- 'title:' parameter fix
          isSelected: false,
          onTap: () {
            // Navigate to the Edit screen using the declared routeName
            Navigator.pushNamedAndRemoveUntil(
              context,
              EditItemsScreen.routeName,
              (route) => false,
            );
          },
        ),
        buildTabItem(
          title: "Disable", // <-- 'title:' parameter fix
          isSelected: false,
          onTap: () {
            // Navigate to the Disable screen using the declared routeName
            Navigator.pushNamedAndRemoveUntil(
              context,
              DisableItemsScreen.routeName,
              (route) => false,
            );
          },
        ),
      ],
    );
  }

  // Widget for each Tab item
  Widget buildTabItem({
    required String title,
    bool isSelected = false,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Column(
        children: [
          Text(
            title,
            style: GoogleFonts.poppins(
              fontSize: 16,
              fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
              color: isSelected ? primaryColor : tabInactiveColor,
            ),
          ),
          const SizedBox(height: 4),
          if (isSelected) Container(height: 3, width: 60, color: primaryColor),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _nameController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }

  // Save the new item
  Future<void> _saveItem() async {
    final name = _nameController.text.trim();
    if (name.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please enter an item name')),
      );
      return;
    }

    if (_selectedCategory == null) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Please select a category')));
      return;
    }

    try {
      // Convert XFile to File if image was picked
      File? imageFile;
      if (_imageFile != null) {
        imageFile = File(_imageFile!.path);
      }

      // Save the item
      await ItemsService.instance.addItem(
        title: name,
        imageFile: imageFile,
        category: _selectedCategory!,
      );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Item added successfully')),
        );
        // Clear form
        _nameController.clear();
        _descriptionController.clear();
        setState(() {
          _imageFile = null;
          _selectedCategory = null;
        });
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('Error adding item: $e')));
      }
    }
  }

      // Save the item
      await ItemsService.instance.addItem(
        title: name,
        imageFile: imageFile,
        category: _selectedCategory!,
      );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Item added successfully')),
        );
        // Clear form
        _nameController.clear();
        _descriptionController.clear();
        setState(() {
          _imageFile = null;
          _selectedCategory = null;
        });

        // Navigate to Browse screen to see the new item
        Navigator.pushNamedAndRemoveUntil(context, '/browse', (route) => false);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error adding item: $e')),
        );
      }
    }
  }

  // Widget for all the form fields
  Widget buildForm() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Item name
        Text(
          "Item name:",
          style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        buildTextField(hint: "Items Name"),
        const SizedBox(height: 16),

        // Item ID
        Text(
          "Item ID:",
          style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        buildTextField(hint: "ID"),
        const SizedBox(height: 16),

        // Item Description
        Text(
          "Item Description:",
          style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        buildTextField(hint: "Description", maxLines: 4),
        const SizedBox(height: 16),

        // Category
        Text(
          "Category:",
          style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        buildCategoryDropdown(),
        const SizedBox(height: 16),

        // Upload Image
        Text(
          "Upload Image",
          style: GoogleFonts.poppins(fontWeight: FontWeight.w500),
        ),
        const SizedBox(height: 8),
        buildImageUploadBox(), // <--- This one is updated
      ],
    );
  }

  // Widget สำหรับ Text Field
  Widget buildTextField({required String hint, int maxLines = 1}) {
    return TextField(
      maxLines: maxLines,
      decoration: InputDecoration(
        hintText: hint,
        hintStyle: GoogleFonts.poppins(color: Colors.black.withOpacity(0.5)),
        filled: true,
        fillColor: formFieldBackgroundColor,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 16,
          vertical: 12,
        ),
      ),
    );
  }

  // Widget for the Category Dropdown
  Widget buildCategoryDropdown() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
      decoration: BoxDecoration(
        color: formFieldBackgroundColor,
        borderRadius: BorderRadius.circular(12),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: _selectedCategory,
          isExpanded: true,
          icon: const Icon(Icons.arrow_drop_down, color: Colors.black54),
          hint: Text(
            "Select Category",
            style: GoogleFonts.poppins(color: Colors.black.withOpacity(0.5)),
          ),
          items: _categories.map((String category) {
            return DropdownMenuItem<String>(
              value: category,
              child: Text(category, style: GoogleFonts.poppins()),
            );
          }).toList(),
          onChanged: (newValue) {
            setState(() {
              _selectedCategory = newValue;
            });
          },
        ),
      ),
    );
  }

  // Widget for Image Upload Box (Updated)
  Widget buildImageUploadBox() {
    return GestureDetector(
      onTap: _showImagePickerOptions, // <--- Show options on tap
      child: Container(
        height: 150, // Added height to accommodate the image
        width: double.infinity,
        padding: const EdgeInsets.all(8), // Reduced padding for the image
        decoration: BoxDecoration(
          color: formFieldBackgroundColor,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: primaryColor.withOpacity(0.7), width: 1.5),
        ),
        // --- Updated display section ---
        child: _imageFile == null
            ? buildUploadPlaceholder() // If no image -> show placeholder
            : buildImagePreview(), // If image exists -> show preview
        // ---
      ),
    );
  }

  // Original widget (extracted)
  Widget buildUploadPlaceholder() {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Icon(Icons.upload_file_outlined, color: Colors.black54, size: 36),
        const SizedBox(height: 8),
        Text(
          "Upload Image",
          style: GoogleFonts.poppins(
            color: Colors.black54,
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  // New widget for image preview
  Widget buildImagePreview() {
    return ClipRRect(
      borderRadius: BorderRadius.circular(10), // Make the image corners rounded
      child: kIsWeb
          ? Image.network(
              // For Web, _imageFile.path is a URL
              _imageFile!.path,
              fit: BoxFit.cover,
              width: double.infinity,
              height: double.infinity,
            )
          : Image.file(
              // For Mobile, _imageFile.path is a file path
              File(_imageFile!.path),
              fit: BoxFit.cover,
              width: double.infinity,
              height: double.infinity,
            ),
    );
  }
  // ---

  // Widget for Cancel and Add buttons
  Widget buildActionButtons() {
    return Row(
      children: [
        // Cancel Button
        Expanded(
          child: ElevatedButton(
            onPressed: () {
              // Navigate back to browse if we can't pop
              if (Navigator.canPop(context)) {
                Navigator.pop(context);
              } else {
                Navigator.pushReplacementNamed(context, '/browse');
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.white,
              foregroundColor: Colors.black,
              side: const BorderSide(color: Colors.grey, width: 1.5),
              padding: const EdgeInsets.symmetric(vertical: 14),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
              ),
            ),
            child: Text(
              "Cancel",
              style: GoogleFonts.poppins(
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
          ),
        ),
        const SizedBox(width: 16),
        // Add Button
        Expanded(
          child: ElevatedButton(
            onPressed: _saveItem,
            style: ElevatedButton.styleFrom(
              backgroundColor: addButtonColor,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 14),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
              ),
            ),
            child: Text(
              "Add",
              style: GoogleFonts.poppins(
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
          ),
        ),
      ],
    );
  }
}
